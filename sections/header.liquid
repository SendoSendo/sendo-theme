{%- liquid
  assign menu = section.settings.menu
  assign sticky = section.settings.sticky_header
  assign color_scheme = section.settings.color_scheme
  assign logo_width = settings.logo_width | default: 120
  assign logo_width_2x = logo_width | times: 2
  assign header_layout = section.settings.header_layout | default: 'default'
-%}

{{ 'component-header.css' | asset_url | stylesheet_tag }}
{%- if header_layout == 'marketplace' -%}
  {{ 'component-mega-menu.css' | asset_url | stylesheet_tag }}
{%- endif -%}

<header
  class="header color-scheme-{{ color_scheme }}{% if sticky != 'none' %} header--sticky header--sticky-{{ sticky }}{% endif %}{% if header_layout == 'marketplace' %} header--marketplace{% endif %}"
  data-section-id="{{ section.id }}"
  data-sticky="{{ sticky }}"
  role="banner"
>
  {%- if header_layout == 'marketplace' -%}
    {%- comment -%}=== MARKETPLACE HEADER LAYOUT ==={%- endcomment -%}
    <div class="header__inner header__inner--marketplace page-width">
      {%- comment -%}Mobile menu toggle{%- endcomment -%}
      <button
        class="header__menu-toggle btn--icon hide-desktop"
        data-mobile-menu-toggle
        aria-label="{{ 'accessibility.menu' | t | default: 'Menu' }}"
        aria-expanded="false"
        aria-controls="MobileMenu"
      >
        {%- render 'util-icon', icon: 'menu' -%}
      </button>

      {%- comment -%}Logo{%- endcomment -%}
      <a href="{{ routes.root_url }}" class="header__logo" aria-label="{{ shop.name }}">
        {%- if settings.logo != blank -%}
          <img
            src="{{ settings.logo | image_url: width: 400 }}"
            srcset="{{ settings.logo | image_url: width: logo_width }} 1x, {{ settings.logo | image_url: width: logo_width_2x }} 2x"
            alt="{{ settings.logo.alt | default: shop.name | escape }}"
            width="{{ logo_width }}"
            height="{{ logo_width | divided_by: settings.logo.aspect_ratio | round }}"
            loading="eager"
            class="header__logo-img"
          >
        {%- else -%}
          <span class="header__logo-text">{{ shop.name }}</span>
        {%- endif -%}
      </a>

      {%- comment -%}Full-width search form{%- endcomment -%}
      <div class="header__search-bar hide-below-desktop">
        <form action="{{ routes.search_url }}" method="get" class="header__search-form" role="search">
          <input type="hidden" name="type" value="product">
          <div class="header__search-form-inner">
            {%- if section.settings.show_category_filter -%}
              <select name="filter.p.product_type" class="header__search-category" aria-label="{{ 'general.search.category' | t | default: 'Category' }}">
                <option value="">{{ 'general.search.all_categories' | t | default: 'All' }}</option>
                {%- for product_type in shop.types -%}
                  {%- if product_type != blank -%}
                    <option value="{{ product_type | escape }}">{{ product_type }}</option>
                  {%- endif -%}
                {%- endfor -%}
              </select>
            {%- endif -%}
            <input
              type="search"
              name="q"
              class="header__search-input"
              placeholder="{{ section.settings.search_placeholder | default: 'Search products...' }}"
              aria-label="{{ 'general.search.title' | t | default: 'Search' }}"
              autocomplete="off"
            >
            <button type="submit" class="header__search-submit btn--icon" aria-label="{{ 'general.search.title' | t | default: 'Search' }}">
              {%- render 'util-icon', icon: 'search', size: 18 -%}
            </button>
          </div>
        </form>
      </div>

      {%- comment -%}Action icons{%- endcomment -%}
      <div class="header__actions">
        {%- if section.settings.show_search -%}
          <a href="{{ routes.search_url }}" class="header__action btn--icon hide-desktop" aria-label="{{ 'general.search.title' | t | default: 'Search' }}" data-search-toggle>
            {%- render 'util-icon', icon: 'search' -%}
          </a>
        {%- endif -%}

        {%- if section.settings.show_account and shop.customer_accounts_enabled -%}
          <details-disclosure>
            <details class="header__account-details hide-mobile">
              <summary class="header__action header__account-toggle btn--icon" aria-label="{{ 'general.account.title' | t | default: 'Account' }}">
                {%- render 'util-icon', icon: 'user' -%}
                <span class="header__account-label hide-below-desktop">
                  {%- if customer -%}
                    {{ customer.first_name | default: 'Account' }}
                  {%- else -%}
                    {{ 'general.account.login' | t | default: 'Sign in' }}
                  {%- endif -%}
                </span>
              </summary>
              <div class="header__account-dropdown">
                <ul class="header__account-menu">
                  {%- if customer -%}
                    <li><a href="{{ routes.account_url }}" class="header__account-link">{%- render 'util-icon', icon: 'user', size: 16 -%} {{ 'general.account.title' | t | default: 'My Account' }}</a></li>
                    <li><a href="{{ routes.account_url }}#orders" class="header__account-link">{%- render 'util-icon', icon: 'truck', size: 16 -%} {{ 'general.account.orders' | t | default: 'Orders' }}</a></li>
                    <li><a href="{{ routes.account_logout_url }}" class="header__account-link">{%- render 'util-icon', icon: 'arrow-right', size: 16 -%} {{ 'general.account.logout' | t | default: 'Log out' }}</a></li>
                  {%- else -%}
                    <li><a href="{{ routes.account_login_url }}" class="header__account-link">{%- render 'util-icon', icon: 'user', size: 16 -%} {{ 'general.account.login' | t | default: 'Log in' }}</a></li>
                    <li><a href="{{ routes.account_register_url }}" class="header__account-link">{%- render 'util-icon', icon: 'plus', size: 16 -%} {{ 'general.account.register' | t | default: 'Create account' }}</a></li>
                  {%- endif -%}
                </ul>
              </div>
            </details>
          </details-disclosure>
        {%- endif -%}

        <a href="{{ routes.cart_url }}" class="header__action header__cart btn--icon" aria-label="{{ 'general.cart.title' | t | default: 'Cart' }}" data-cart-toggle>
          {%- render 'util-icon', icon: 'cart' -%}
          <span class="header__cart-count" data-cart-count {% if cart.item_count == 0 %}hidden{% endif %}>
            {{ cart.item_count }}
          </span>
        </a>
      </div>
    </div>

  {%- else -%}
    {%- comment -%}=== DEFAULT HEADER LAYOUT ==={%- endcomment -%}
    <div class="header__inner page-width">
      {%- comment -%}Mobile menu toggle{%- endcomment -%}
      <button
        class="header__menu-toggle btn--icon hide-desktop"
        data-mobile-menu-toggle
        aria-label="{{ 'accessibility.menu' | t | default: 'Menu' }}"
        aria-expanded="false"
        aria-controls="MobileMenu"
      >
        {%- render 'util-icon', icon: 'menu' -%}
      </button>

      {%- comment -%}Logo{%- endcomment -%}
      <a href="{{ routes.root_url }}" class="header__logo" aria-label="{{ shop.name }}">
        {%- if settings.logo != blank -%}
          <img
            src="{{ settings.logo | image_url: width: 400 }}"
            srcset="{{ settings.logo | image_url: width: logo_width }} 1x, {{ settings.logo | image_url: width: logo_width_2x }} 2x"
            alt="{{ settings.logo.alt | default: shop.name | escape }}"
            width="{{ logo_width }}"
            height="{{ logo_width | divided_by: settings.logo.aspect_ratio | round }}"
            loading="eager"
            class="header__logo-img"
          >
        {%- else -%}
          <span class="header__logo-text">{{ shop.name }}</span>
        {%- endif -%}
      </a>

      {%- comment -%}Desktop navigation{%- endcomment -%}
      <nav class="header__nav hide-below-desktop" aria-label="{{ 'accessibility.main_navigation' | t | default: 'Main navigation' }}">
        {%- if menu != blank -%}
          <ul class="header__menu" role="menubar">
            {%- for link in linklists[menu].links -%}
              <li
                class="header__menu-item{% if link.links.size > 0 %} header__menu-item--has-children{% endif %}"
                role="none"
              >
                {%- if link.links.size > 0 -%}
                  <details-disclosure>
                    <details>
                      <summary
                        class="header__link{% if link.active or link.child_active %} header__link--active{% endif %}"
                        role="menuitem"
                        aria-haspopup="true"
                      >
                        {{ link.title }}
                        {%- render 'util-icon', icon: 'chevron-down', size: 12 -%}
                      </summary>

                      <div class="header__dropdown">
                        <div class="header__dropdown-inner page-width">
                          <ul class="header__dropdown-menu" role="menu">
                            {%- for child_link in link.links -%}
                              <li role="none">
                                {%- if child_link.links.size > 0 -%}
                                  <span class="header__dropdown-heading">{{ child_link.title }}</span>
                                  <ul class="header__dropdown-submenu" role="menu">
                                    {%- for grandchild_link in child_link.links -%}
                                      <li role="none">
                                        <a
                                          href="{{ grandchild_link.url }}"
                                          class="header__dropdown-link{% if grandchild_link.active %} header__dropdown-link--active{% endif %}"
                                          role="menuitem"
                                        >
                                          {{ grandchild_link.title }}
                                        </a>
                                      </li>
                                    {%- endfor -%}
                                  </ul>
                                {%- else -%}
                                  <a
                                    href="{{ child_link.url }}"
                                    class="header__dropdown-link{% if child_link.active %} header__dropdown-link--active{% endif %}"
                                    role="menuitem"
                                  >
                                    {{ child_link.title }}
                                  </a>
                                {%- endif -%}
                              </li>
                            {%- endfor -%}
                          </ul>

                          {%- comment -%}In-menu promo block{%- endcomment -%}
                          {%- for block in section.blocks -%}
                            {%- if block.type == 'mega_menu_promo' and block.settings.menu_item == link.title -%}
                              <div class="header__dropdown-promo" {{ block.shopify_attributes }}>
                                {%- if block.settings.image != blank -%}
                                  <div class="header__dropdown-promo-image">
                                    {%- render 'util-responsive-image',
                                      image: block.settings.image,
                                      sizes: '300px',
                                      widths: '300,600',
                                      aspect_ratio: '3/4'
                                    -%}
                                  </div>
                                {%- endif -%}
                                {%- if block.settings.heading != blank -%}
                                  <p class="header__dropdown-promo-heading">{{ block.settings.heading }}</p>
                                {%- endif -%}
                                {%- if block.settings.link != blank -%}
                                  <a href="{{ block.settings.link }}" class="header__dropdown-promo-link btn btn--sm btn--secondary">
                                    {{ block.settings.link_text | default: 'Shop now' }}
                                  </a>
                                {%- endif -%}
                              </div>
                            {%- endif -%}
                          {%- endfor -%}
                        </div>
                      </div>
                    </details>
                  </details-disclosure>
                {%- else -%}
                  <a
                    href="{{ link.url }}"
                    class="header__link{% if link.active %} header__link--active{% endif %}"
                    role="menuitem"
                  >
                    {{ link.title }}
                  </a>
                {%- endif -%}
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}
      </nav>

      {%- comment -%}Action icons{%- endcomment -%}
      <div class="header__actions">
        {%- if section.settings.show_search -%}
          <a href="{{ routes.search_url }}" class="header__action btn--icon" aria-label="{{ 'general.search.title' | t | default: 'Search' }}">
            {%- render 'util-icon', icon: 'search' -%}
          </a>
        {%- endif -%}

        {%- if section.settings.show_account and shop.customer_accounts_enabled -%}
          <a href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}" class="header__action btn--icon hide-mobile" aria-label="{{ 'general.account.title' | t | default: 'Account' }}">
            {%- render 'util-icon', icon: 'user' -%}
          </a>
        {%- endif -%}

        <a href="{{ routes.cart_url }}" class="header__action header__cart btn--icon" aria-label="{{ 'general.cart.title' | t | default: 'Cart' }}" data-cart-toggle>
          {%- render 'util-icon', icon: 'cart' -%}
          <span class="header__cart-count" data-cart-count {% if cart.item_count == 0 %}hidden{% endif %}>
            {{ cart.item_count }}
          </span>
        </a>
      </div>
    </div>
  {%- endif -%}

  {%- comment -%}Mobile menu drawer (shared by both layouts){%- endcomment -%}
  <div class="header__mobile-menu" id="MobileMenu" data-mobile-menu aria-hidden="true">
    <div class="header__mobile-menu-inner">
      <div class="header__mobile-menu-header">
        {%- if customer -%}
          <div class="header__mobile-greeting">
            <span class="header__mobile-greeting-text">{{ 'general.account.greeting' | t | default: 'Hello' }}, {{ customer.first_name }}</span>
          </div>
        {%- else -%}
          <span class="header__mobile-menu-title">{{ 'general.menu' | t | default: 'Menu' }}</span>
        {%- endif -%}
        <button class="btn--icon" data-mobile-menu-close aria-label="{{ 'accessibility.close' | t | default: 'Close' }}">
          {%- render 'util-icon', icon: 'close' -%}
        </button>
      </div>

      <nav class="header__mobile-nav" aria-label="{{ 'accessibility.main_navigation' | t | default: 'Main navigation' }}">
        {%- if menu != blank -%}
          <ul class="header__mobile-menu-list">
            {%- for link in linklists[menu].links -%}
              <li class="header__mobile-menu-item">
                {%- if link.links.size > 0 -%}
                  <details class="header__mobile-details">
                    <summary class="header__mobile-link">
                      {{ link.title }}
                      {%- render 'util-icon', icon: 'chevron-down', size: 16 -%}
                    </summary>
                    <ul class="header__mobile-submenu">
                      {%- for child_link in link.links -%}
                        <li>
                          {%- if child_link.links.size > 0 -%}
                            <details class="header__mobile-details header__mobile-details--level-2">
                              <summary class="header__mobile-sublink header__mobile-sublink--parent">
                                {{ child_link.title }}
                                {%- render 'util-icon', icon: 'chevron-down', size: 14 -%}
                              </summary>
                              <ul class="header__mobile-submenu header__mobile-submenu--level-2">
                                <li>
                                  <a href="{{ child_link.url }}" class="header__mobile-sublink header__mobile-sublink--all">
                                    {{ 'general.menu.shop_all' | t | default: 'All' }} {{ child_link.title }}
                                  </a>
                                </li>
                                {%- for grandchild_link in child_link.links -%}
                                  <li>
                                    <a href="{{ grandchild_link.url }}" class="header__mobile-sublink">{{ grandchild_link.title }}</a>
                                  </li>
                                {%- endfor -%}
                              </ul>
                            </details>
                          {%- else -%}
                            <a href="{{ child_link.url }}" class="header__mobile-sublink">{{ child_link.title }}</a>
                          {%- endif -%}
                        </li>
                      {%- endfor -%}
                    </ul>
                  </details>
                {%- else -%}
                  <a href="{{ link.url }}" class="header__mobile-link">{{ link.title }}</a>
                {%- endif -%}
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}
      </nav>

      {%- comment -%}Account section{%- endcomment -%}
      {%- if shop.customer_accounts_enabled -%}
        <div class="header__mobile-account">
          <a href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}" class="header__mobile-link">
            {%- render 'util-icon', icon: 'user', size: 18 -%}
            {%- if customer -%}
              {{ 'general.account.title' | t | default: 'Account' }}
            {%- else -%}
              {{ 'general.account.login' | t | default: 'Log in' }}
            {%- endif -%}
          </a>
        </div>
      {%- endif -%}

      {%- comment -%}Utility links{%- endcomment -%}
      <div class="header__mobile-utility">
        {%- if section.settings.show_help_link -%}
          <a href="{{ section.settings.help_link | default: routes.root_url }}" class="header__mobile-utility-link">
            {%- render 'util-icon', icon: 'eye', size: 16 -%}
            {{ section.settings.help_text | default: 'Help & Support' }}
          </a>
        {%- endif -%}
      </div>
    </div>
  </div>
</header>

<script src="{{ 'component-header.js' | asset_url }}" defer></script>
<script src="{{ 'component-details-disclosure.js' | asset_url }}" defer></script>
{%- if header_layout == 'marketplace' -%}
  <script src="{{ 'component-mega-menu.js' | asset_url }}" defer></script>
{%- endif -%}

{% schema %}
{
  "name": "Header",
  "class": "header-section",
  "settings": [
    {
      "type": "select",
      "id": "header_layout",
      "label": "Header layout",
      "options": [
        { "value": "default", "label": "Default (centered nav)" },
        { "value": "marketplace", "label": "Marketplace (Amazon-style)" }
      ],
      "default": "marketplace"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "sticky_header",
      "label": "Sticky header",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "on-scroll-up", "label": "On scroll up" },
        { "value": "always", "label": "Always" }
      ],
      "default": "on-scroll-up"
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show search",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account",
      "label": "Show account",
      "default": true
    },
    {
      "type": "header",
      "content": "Marketplace search"
    },
    {
      "type": "checkbox",
      "id": "show_category_filter",
      "label": "Show category filter in search",
      "default": true,
      "info": "Only applies to marketplace layout. Shows a category dropdown in the search bar."
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search placeholder text",
      "default": "Search products..."
    },
    {
      "type": "header",
      "content": "Mobile utilities"
    },
    {
      "type": "checkbox",
      "id": "show_help_link",
      "label": "Show help link in mobile menu",
      "default": false
    },
    {
      "type": "url",
      "id": "help_link",
      "label": "Help page link"
    },
    {
      "type": "text",
      "id": "help_text",
      "label": "Help link text",
      "default": "Help & Support"
    }
  ],
  "blocks": [
    {
      "type": "mega_menu_promo",
      "name": "Mega menu promo",
      "settings": [
        {
          "type": "text",
          "id": "menu_item",
          "label": "Menu item title",
          "info": "Enter the exact title of the top-level menu item this promo should appear in."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "New Arrivals"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link text",
          "default": "Shop now"
        }
      ]
    }
  ]
}
{% endschema %}
